---
title: "Cod landings project"
author: "Kristin, Delphine, Reese"
date: "2023-02-08"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r upload-packages}
#install.packages("tidyverse")
library(tidyverse)
#install.packages("devtools")
library(devtools)
#devtools::install_github("rstudio-education/dsbox", force = TRUE)
library(dsbox)
#install.packages("ggridges")
library(ggridges)
#install.packages("gganimate")
library(gganimate)
#install.packages("janitor")
library(janitor)
#install.packages("stringr")
library(stringr) ## String manipulation
#install.packages("plotly")
library(plotly)
#install.packages("usmap")
library(usmap)
library(ggplot2)
#install.packages("devtools")
#devtools::install_github("UrbanInstitute/urbnmapr")
library(urbnmapr)
#install.packages("leaflet")
library(leaflet) ## For leaflet interactive maps
#install.packages("sf")
library(sf) ## For spatial data
#install.packages("RColorBrewer")
library(RColorBrewer) ## For colour palettes
#install.packages("htmltools")
library(htmltools) ## For html
#install.packages("leafsync")
library(leafsync) ## For placing plots side by side
#install.packages("kableExtra")
library(kableExtra) ## Table output
#install.packages("stringr")
library(stringr) ## String manipulation
library(gganimate)
library(transformr)
#install.packages("ggimage")
library(ggimage)
#install.packages("naniar")
library(naniar)
#install.packages("visdat")
library(visdat)
```

```{r us_maps-shapefile}

us_maps <- us_map(region = "states")

states_sf <- get_urbn_map(map = "states", sf = TRUE)


```



```{r modify-column-names}
cod_landings <- read_csv("data/cod-landings.csv")  
cod_landings <- cod_landings 
names(cod_landings)[names(cod_landings) == "NMFS Name"] <- "Common_Name"
names(cod_landings)[names(cod_landings) == "Metric Tons"] <- "Metric_Tons"
names(cod_landings)[names(cod_landings) == "Dollars"] <- "US_Dollars"
names(cod_landings)[names(cod_landings) == "Scientific Name"] <- "Scientific_Name"
names(cod_landings)[names(cod_landings) == "Collection"] <- "Fishing_Types"
names(cod_landings)[names(cod_landings) == "Tsn"] <- "Taxonomic_Serial_Number"
names(cod_landings)[names(cod_landings) == "Source"] <- "Fishing_Companies"
colnames(cod_landings)

```
```{r glimpe-dataset}
glimpse(cod_landings)
```

```{r change-wording-dataset}
cod_landings$Common_Name <- str_replace(cod_landings$Common_Name,"COD, PACIFIC", "Pacific_Cod")

cod_landings$Common_Name <- str_replace(cod_landings$Common_Name,"COD, ATLANTIC", "Atlantic_Cod")

cod_landings$Scientific_Name <- str_replace(cod_landings$Scientific_Name, "Gadus macrocephalus", "Gadus_macrocephalus")

cod_landings$Scientific_Name <- str_replace(cod_landings$Scientific_Name, "Gadus morhua", "Gadus_morhua")
cod_landings
```

Q1 - How do the weights of recorded recreational and commercial Cod landings of the Atlantic and Pacific compare to one another between the years 1950 and 2021?
Plan Q1 - Summarize the data through a ridgeline density plot of weight of landings, colored by “Fishing_Type” and faceted by “Common_Name”. Also include an animated plot of the same type to better show the fluctuation in landings every 10 years. 

```{r filter-out-arctic-and-toothed-cod}
cod_landings <- cod_landings %>% 
  filter(Common_Name != "COD, TOOTHED" ) %>% 
  filter(Common_Name != "COD, ARCTIC" )
```

```{r mutate-total-metric-tons-column}
cod_landings_total <- cod_landings %>%
  group_by(Year) %>%
   mutate(Total_Metric_Tons = sum(Metric_Tons, na.rm = TRUE)) %>%
  arrange(desc(Year))
view(cod_landings_total)

```

```{r mutate-total-pounds-column}
cod_landings_total <- cod_landings %>%
  group_by(Year) %>%
   mutate(Total_Pounds = sum(Pounds, na.rm = TRUE)) %>%
  arrange(desc(Year))
```

```{r count-total-ponds-choose-sclae-axis-graph}
cod_landings_total %>% 
  group_by(Total_Pounds) %>% 
count(Total_Pounds) %>% 
  arrange(desc(Total_Pounds))
```

```{r cod-image}
cod_image <- "pacific-cod.webp"
cod_landings_total %>%
  mutate(
    image = case_when(Year %in% c(1950:2021) ~ cod_image,
                      TRUE ~ cod_image)) 
```

```{r cod-image-graph-with-path}
#this would be the first graph shown just to quiclyky differentiate btw pacific and atlantic cods
#is there a way to keep the columns in here?
fish_coords <- cod_landings_total %>%
  group_by(Year, Common_Name) %>%
  summarize(Total_Pounds = sum(Total_Pounds, na.rm = T))


fish_coords %>% 
  ggplot(mapping = aes(
         x = Year,
         y = Total_Pounds/1000000)) +
  geom_col(data = cod_landings_total, aes(fill = Common_Name))+
  geom_path(data = fish_coords) +
  geom_point(data = fish_coords) +
  geom_image(data = fish_coords, aes(image = cod_image), size = 0.1, alpha = 0.3) + 
  scale_color_manual(values = fill) +
    scale_x_continuous(breaks = seq(1950, 2021, 10))+
    #scale_y_continuous(breaks = seq(40000000,730000000, 500000000))+
  facet_wrap (~ Common_Name, nrow=2, scales = "free_x") +
  scale_fill_viridis_d() +
   labs(title = "US Pacific and Atlantic Cod Landings From 1950 to 2021",
        subtitle = "In Millions of Pounds",
        x = "Years",
        y = "Millions of Pounds",
        fill = "Fish Species' Common Name") +
   transition_reveal(Year)

   
 
 #cod_anim <- cod_anim + transition_time(Year) + shadow_mark(past = TRUE, future = FALSE)
 #ease_aes('linear') 
 
 # animate(cod_anim) #nframes = 30, fps = 10, width = 600, height = 400)

```

```{r cod-anim-trial}
#trhis is a different version of the previous graph = a trial woith gg-animate
#see if can have only image animation without the whole animation
#add backgroup theme coclors for atlantic and pacific cod corresponding to rpevious plot
#make size and fonts more interesting/sitll accessible 

fish_coords <- cod_landings_total %>%
  group_by(Year, Common_Name) %>%
  summarize(Total_Pounds = sum(Total_Pounds, na.rm = T))


 cod_anim <- ggplot(mapping = aes(
         x = Year,
         y = Total_Pounds/1000000)) +
  geom_col(data = cod_landings_total, aes(fill = Common_Name))+
  geom_point(data = fish_coords) +
  geom_image(data = fish_coords, aes(image = cod_image), size = 0.1, alpha = 0.3) + 
    scale_x_continuous(breaks = seq(1950, 2021, 10))+
    #scale_y_continuous(breaks = seq(40000000,730000000, 500000000))+
  facet_wrap (~ Common_Name, nrow = 2, scales = "free_x") +
  scale_fill_viridis_d() +
   labs(title = "US Pacific and Atlantic Cod Landings From 1950 to 2021",
        subtitle = "In Millions of Pounds",
        x = "Years",
        y = "Millions of Pounds",
        fill = "Fish Species'Common Name")

   
 
 cod_anim <- cod_anim + transition_time(Year) + shadow_mark(past = TRUE, future = FALSE)
 ease_aes('linear') 
 
  animate(cod_anim) #nframes = 30, fps = 10, width = 600, height = 400)

```


```{r Q1-interactive-landings-by-fishing-types, fig.height=8, fig.width=6}
#this graph allows more in depth analysis of the data, its interactive to get more information, reference line for specific laws or useful information

#change the total pounds column in dataset so that it is /1000000 too so that when you click on the interactive chart the info you see is also more accessible (like on the y-axis)
#figure out how to add labels
#add "accessible" colors?
#add information about the graph text
Graph_01 <- cod_landings_total %>% 
  group_by(Common_Name) %>%
  ggplot(mapping = aes(
         x = Year,
         y = Total_Pounds/1000000,
         fill = Fishing_Types)) +
    geom_col(alpha=0.5) +
   # geom_line() +
    geom_vline(xintercept = 1992, color = "red" ) +
  #  geom_text(aes(v_line, label = "1992 Cod Moratorium")) +
    scale_x_continuous(breaks = seq(1950, 2021, 10))+
    labs(title = "Atlantic and Pacific Cod Landings By Fishing Types",
         subtitle = "From 1950 to 2021",
         x = "Years",
         y = "Millions of Pounds",
         fill = "Fishing Type")+
  facet_wrap( ~ Common_Name, nrow = 2, scales = "free_x")

Graph_01 <- ggplotly(Graph_01) 
Graph_01

# if want to choose color --> geom_area(fill="#69b3a2", alpha=0.5) +
 # geom_line(color="#69b3a2") 


```


QUESTION 2

```{r rename} {col-capitailzation}
states_sf <- states_sf %>% 
  mutate(state_name = tolower(state_name))

states_sf <- states_sf %>%
  rename("State" = "state_name")
 

cod_landings <- cod_landings %>%
  mutate(State = tolower(State))
```

```{r commercial-profit}
cod_landings_commercial <- cod_landings %>%
  na.omit(US_Dollars) %>%
  rename(Commercial_Profit = US_Dollars)
```

```{r transform-sf}
states_sf <- st_transform(states_sf, "+init=epsg:4326")
st_crs(states_sf)
```

```{r join-shapefile}
cod_landings_commercial_total <- cod_landings_commercial %>% 
  full_join(states_sf, by = "State")

cod_landings_commercial_total <- st_sf(cod_landings_commercial_total)
```



```{r 1950-map}

 cod_landings_commercial_total %>%
  filter(Year %in% c(1950, 1980, 1997, 2021)) %>%
  ggplot() +
  geom_sf(aes(fill = Commercial_Profit)) + #figure out expand
  facet_wrap(. ~ Year)
transition_time(time = Year)
```
```{r}
ggplot(cod_landings_commercial_total) +
   geom_sf(aes(fill = Metric_Tons))
```


```{r missing-data}
cod_landings %>%
  ggplot(aes(x = Pounds, y = Fishing_Types))+
  geom_point()+
  geom_miss_point()
```

